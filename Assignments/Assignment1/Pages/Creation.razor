@page "/Creation"
@using Assignment1.Data
@using Assignment1.Models
@using Assignment1.Persistence
@using Microsoft.AspNetCore.Components
@inject IFamilyData familyData
@inject NavigationManager NavigationManager
@inject FileContext FileContext

<h1>The power of creation</h1>

<div class="container">
    <div class="row">
        <div class="col-sm-6">
            <h3>Add new family</h3>
            <EditForm Model="@newFamily" OnValidSubmit="@AddNewFamily">
                <DataAnnotationsValidator/>
                <ValidationSummary/>
                <div class="form-group">
                    Streetname:<br/>
                    <InputTextArea rows="1" @bind-Value="newFamily.StreetName"/>
                </div>
                <div class="form-group">
                    House number:<br/>
                    <InputNumber rows="1" @bind-Value="newFamily.HouseNumber"/>
                </div>
                <p class="actions">
                    <button class="btn btn-outline-dark btn-primary" type="submit">Create</button>
                </p>
                <div style="color:red">@errorMsg</div>

            </EditForm>
        </div>
        <div class="col-sm-6 justify-content-center">
            <h3>Add new adult to family</h3>


            <EditForm Model="@newAdult" OnValidSubmit="@AddNewAdult">
                <DataAnnotationsValidator/>
                <ValidationSummary/>
                <p class="font-weight-bold">Adult information</p>
                <div class="form-group">
                    Firstname:<br/>
                    <InputTextArea rows="1" @bind-Value="newAdult.FirstName"/>
                </div>
                <div class="form-group">
                    Lastname:<br/>
                    <InputTextArea rows="1" @bind-Value="newAdult.LastName"/>
                </div>
                <div class="form-group">
                    Haircolor:<br/>
                    <InputTextArea rows="1" @bind-Value="newAdult.HairColor"/>
                </div>
                <div class="form-group">
                    Eyecolor:<br/>
                    <InputTextArea rows="1" @bind-Value="newAdult.EyeColor"/>
                </div>
                <div class="form-group">
                    Age:<br/>
                    <InputNumber rows="1" @bind-Value="newAdult.Age"/>
                </div>
                <div class="form-group">
                    Weight:<br/>
                    <InputNumber rows="1" @bind-Value="newAdult.Weight"/>
                </div>
                <div class="form-group">
                    Height:<br/>
                    <InputNumber rows="1" @bind-Value="newAdult.Height"/>
                </div>
                <div class="form-group">
                    Sex:<br/>
                    <InputTextArea rows="1" @bind-Value="newAdult.Sex"/>
                </div>
                <p class="font-weight-bold">Job information</p>
                <div class="form-group">
                    Job:<br/>
                    <InputTextArea rows="1" @bind-Value="newJob.JobTitle"/>
                </div>
                <div class="form-group">
                    Salary:<br/>
                    <InputNumber rows="1" @bind-Value="newJob.Salary"/>
                </div>
                <p class="font-weight-bold">Family information</p>
                <div class="form-group">
                    Streetname:<br/>
                    <InputTextArea rows="1" @bind-Value="chosenFamily.StreetName"/>
                </div>
                <div class="form-group">
                    House number:<br/>
                    <InputNumber rows="1" @bind-Value="chosenFamily.HouseNumber"/>
                </div>

                <p class="actions">
                    <button class="btn btn-outline-dark btn-primary" type="submit">Create</button>
                    <div style="color:red">@errorMsg2</div>
                </p>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private Adult newAdult = new Adult();
    private Job newJob = new Job();

    private Family newFamily = new Family()
    {
        Adults = new List<Adult>(),
        Children = new List<Child>(),
        Pets = new List<Pet>()
    };

    private Family chosenFamily = new Family();

   
    
    private string errorMsg;
    private string errorMsg2;
    private IList<Family> familiesToShow;
    private IList<Family> allFamilies;
    private IList<int> houseNumbers = new List<int>();

    protected override async Task OnInitializedAsync()
    {
        allFamilies = familyData.GetFamilies();
        familiesToShow = null;
    }

    private void FilterByFamily(string changeEventArgs)
    {
        chosenFamily.StreetName = changeEventArgs;


        houseNumbers.Clear();
        foreach (var family in allFamilies)
        {
            if (family.StreetName.Equals(chosenFamily.StreetName))
            {
                houseNumbers.Add(family.HouseNumber);
            }
        }
    }

    private void Filterfamilies()
    {
    // currentFamily.HouseNumber = s;
        ExecuteFamilyFilter();
    }

    private void ExecuteFamilyFilter()
    {
        chosenFamily = allFamilies.FirstOrDefault(f => (chosenFamily.StreetName.Equals(f.StreetName) && chosenFamily.HouseNumber == f.HouseNumber && chosenFamily.StreetName != null));
    }

    private void AddNewFamily()
    {
        errorMsg = "";
        try
        {
            familyData.AddFamily(newFamily.StreetName, newFamily.HouseNumber);
        }
        catch (Exception e)
        {
            errorMsg = e.Message;
        }
    }

    private void AddNewAdult()
    {
        errorMsg2 = "";
        int max = familyData.GetAdults().Max(adult => adult.Id);
        newAdult.Id = (++max);
        newAdult.JobTitle = newJob;

        try
        {
            familyData.AddAdult(newAdult.FirstName, newAdult.LastName, newAdult.HairColor,
                newAdult.EyeColor, newAdult.Age, newAdult.Weight, newAdult.Height,
                newAdult.Sex, newJob.JobTitle, newJob.Salary, chosenFamily.StreetName, chosenFamily.HouseNumber);
        }
        catch (Exception e)
        {
            errorMsg2 = e.Message;
        }
    }

}